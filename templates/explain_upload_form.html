<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>▶IPYNB</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="{{ url_for('home') }}" class="nav-brand">IPYNB Converter</a>
            <ul class="nav-menu">
                <li class="nav-item"><a href="{{ url_for('home') }}" class="nav-link">Into PDF</a></li>
                <li class="nav-item"><a href="{{ url_for('explain_code_page') }}" class="nav-link active">Explain Code✨</a></li>
            </ul>
        </div>
    </nav>

    <div id="loadingOverlay">
        <div class="loading-spinner"></div>
        <p class="loading-text">Generating explanations...</p>
    </div>

    <!-- AI Model Selection Modal -->
    <div id="modelChooserModal" class="modal">
        <div class="modal-content large">
            <span class="close-button" onclick="closeModelChooserModal()">×</span>
            <h2>Select AI Models</h2>
            <p>Check the models you want to use for code explanation. Hover for details.</p>
            <div class="modal-search-bar">
                <input type="text" id="modelSearchInput" onkeyup="filterAvailableModels()" placeholder="Search available models (e.g., GPT, Llama, Mixtral)...">
            </div>
            <div id="availableModelListContainer" class="model-list-container checkboxes">
                <!-- Available models will be populated by JS -->
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-apply-models" onclick="applyModelSelections()">Apply & Close</button>
            </div>
        </div>
    </div>

    <div class="page-content">
        <div class="container">
            <h1>Explain Notebook Code</h1>
            <p>Upload your Jupyter Notebook. Explanations will be generated by the selected AI models below.</p>

            {% with messages = get_flashed_messages(with_categories=true) %}
              {% if messages %}
                <div class="flashes">
                {% for category, message in messages %}
                  <div class="flash-message {{ category }}">{{ message }}</div>
                {% endfor %}
                </div>
              {% endif %}
            {% endwith %}

            <form id="explainForm" action="{{ url_for('explain_code_page') }}" method="post" enctype="multipart/form-data" class="upload-form">
                <div id="hiddenSelectedModelsContainer">
                    {% for model_id in current_selected_ids %}
                        <input type="hidden" name="selected_model_ids" value="{{ model_id }}">
                    {% endfor %}
                </div>

                <!-- Remodeled "Choose your AI model" section -->
                <div class="ai-model-selection-panel">
                    <div class="panel-header">
                        <h4>Selected AI Models for Explanation</h4>
                        <button type="button" class="btn-manage-models" onclick="openModelChooserModal()">
                            <i class="fas fa-plus-circle"></i> Add / Manage Models
                        </button>
                    </div>
                    <div id="selectedModelsTagContainer" class="selected-models-tags">
                        <!-- Selected model tags will be populated by JS -->
                        <span class="no-models-selected-text">No models selected. Click 'Add / Manage Models'.</span>
                    </div>
                </div>

                <div class="file-input-wrapper">
                    <label for="ipynb_file" class="file-input-label">Click or Drag to Select .ipynb File</label>
                    <input type="file" name="ipynb_file" id="ipynb_file" accept=".ipynb" required>
                    <span id="fileName">No file chosen</span>
                </div>
                <button type="submit" id="submitBtn" disabled>Explain Code</button>
            </form>
        </div>
    </div>

<script>
    const allAvailableModels = {{ models | tojson | safe }};
    let currentSelectedModelIds = {{ current_selected_ids | tojson | safe }};

    const fileInput = document.getElementById('ipynb_file');
    const fileNameDisplay = document.getElementById('fileName');
    const submitBtn = document.getElementById('submitBtn');
    const explainForm = document.getElementById('explainForm');
    const loadingOverlay = document.getElementById('loadingOverlay');

    const modelChooserModal = document.getElementById('modelChooserModal');
    const availableModelListContainer = document.getElementById('availableModelListContainer');
    const hiddenSelectedModelsContainer = document.getElementById('hiddenSelectedModelsContainer');
    const modelSearchInput = document.getElementById('modelSearchInput');
    const selectedModelsTagContainer = document.getElementById('selectedModelsTagContainer');
    const noModelsSelectedText = selectedModelsTagContainer.querySelector('.no-models-selected-text');


    fileInput.addEventListener('change', function() {
        fileNameDisplay.textContent = this.files.length > 0 ? this.files[0].name : 'No file chosen';
        submitBtn.disabled = this.files.length === 0;
    });

    explainForm.addEventListener('submit', function(event) {
        if (currentSelectedModelIds.length === 0) {
            alert("Please select at least one AI model by clicking 'Add / Manage Models'.");
            event.preventDefault();
            return;
        }
        if (fileInput.files.length > 0) {
            loadingOverlay.style.display = 'flex';
        }
    });

    window.onclick = function(event) {
        if (event.target == modelChooserModal) closeModelChooserModal();
    };

    function openModelChooserModal() {
        populateAvailableModelsList();
        modelChooserModal.style.display = "block";
        modelSearchInput.value = "";
        filterAvailableModels();
        modelSearchInput.focus();
    }

    function closeModelChooserModal() {
        modelChooserModal.style.display = "none";
    }

    function applyModelSelections() {
        currentSelectedModelIds = [];
        const checkboxes = availableModelListContainer.querySelectorAll('input[type="checkbox"]:checked');
        checkboxes.forEach(checkbox => {
            currentSelectedModelIds.push(checkbox.value);
        });
        updateSelectedModelsDisplay();
        updateHiddenInputs();
        closeModelChooserModal();
    }

    function populateAvailableModelsList() {
        availableModelListContainer.innerHTML = '';
        if (!allAvailableModels || allAvailableModels.length === 0) {
            availableModelListContainer.innerHTML = '<p class="no-models-message">No AI models available. Check API key or server logs.</p>';
            return;
        }
        allAvailableModels.forEach(model => {
            const isChecked = currentSelectedModelIds.includes(model.id);
            const modelItemDiv = document.createElement('div');
            modelItemDiv.className = 'model-item-checkbox'; // This div will enable hover for tooltip

            // Create unique ID for checkbox and label
            const checkboxId = `model_cb_${model.id.replace(/[^a-zA-Z0-9_]/g, '_')}`;

            modelItemDiv.innerHTML = `
                <input type="checkbox" id="${checkboxId}" name="available_models" value="${model.id}" ${isChecked ? 'checked' : ''}>
                <label for="${checkboxId}">
                     <span class="model-name">${model.name || model.id}</span>
                </label>
                <div class="model-tooltip">

                    <strong>Name:</strong> ${model.name || model.id}<br>
                    <strong>Context:</strong> ${model.context_length || 'N/A'} tokens<br>
                    <strong>Pricing (prompt):</strong> $${(model.pricing && model.pricing.prompt != null) ? (parseFloat(model.pricing.prompt) * 1000).toFixed(6) : 'N/A'}/1k tokens<br>
                    <strong>Pricing (completion):</strong> $${(model.pricing && model.pricing.completion != null) ? (parseFloat(model.pricing.completion) * 1000).toFixed(6) : 'N/A'}/1k tokens<br>
                    <hr>
                    <p class="model-description-tooltip">${(model.description || 'No description available.').substring(0,200)}${ (model.description && model.description.length > 200) ? '...' : ''}</p>
                </div>
            `;
            availableModelListContainer.appendChild(modelItemDiv);
        });
    }

    function updateSelectedModelsDisplay() {
        selectedModelsTagContainer.innerHTML = ''; // Clear existing tags
        if (currentSelectedModelIds.length === 0) {
            const placeholder = document.createElement('span');
            placeholder.className = 'no-models-selected-text';
            placeholder.textContent = "No models selected. Click 'Add / Manage Models'.";
            selectedModelsTagContainer.appendChild(placeholder);
            return;
        }

        currentSelectedModelIds.forEach(modelId => {
            const model = allAvailableModels.find(m => m.id === modelId);
            if (model) {
                const tag = document.createElement('div');
                tag.className = 'model-tag';
                tag.innerHTML = `
                    <span>${model.name || model.id}</span>
                    <button type="button" class="remove-tag-btn" onclick="removeSelectedModel('${model.id}', event)">×</button>
                `;
                selectedModelsTagContainer.appendChild(tag);
            }
        });
    }

    function updateHiddenInputs() {
        hiddenSelectedModelsContainer.innerHTML = '';
        currentSelectedModelIds.forEach(modelId => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'selected_model_ids';
            input.value = modelId;
            hiddenSelectedModelsContainer.appendChild(input);
        });
    }

    function removeSelectedModel(modelId, event) {
        if (event) event.stopPropagation();
        currentSelectedModelIds = currentSelectedModelIds.filter(id => id !== modelId);
        updateSelectedModelsDisplay();
        updateHiddenInputs();
        // Also uncheck in modal if it's open (or do this when modal opens)
        const checkboxInModal = document.getElementById(`model_cb_${modelId.replace(/[^a-zA-Z0-9_]/g, '_')}`);
        if (checkboxInModal) checkboxInModal.checked = false;
    }

    function filterAvailableModels() {
        const filter = modelSearchInput.value.toUpperCase();
        const items = availableModelListContainer.getElementsByClassName("model-item-checkbox");
        for (let i = 0; i < items.length; i++) {
            let labelText = items[i].querySelector('label .model-name').textContent.toUpperCase();
            let modelIdFromValue = items[i].querySelector('input[type="checkbox"]').value.toUpperCase();
            if (labelText.indexOf(filter) > -1 || modelIdFromValue.indexOf(filter) > -1) {
                items[i].style.display = "flex"; // Ensure display is flex for alignment
            } else {
                items[i].style.display = "none";
            }
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        updateSelectedModelsDisplay();
        // Hidden inputs are initially rendered by Jinja for current_selected_ids
        updateHiddenInputs(); // Sync on load just in case
    });
</script>
</body>
</html>